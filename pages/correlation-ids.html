<!DOCTYPE html><html><head><title>Correlation IDs in Practice</title><link href="/styles/article.css" rel="stylesheet"><link href="/styles/hljs.css" rel="stylesheet"><link href="/styles/main.css" rel="stylesheet"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-91252031-1', 'auto');
ga('send', 'pageview');</script></head><body><header><h1 id="steve-konves">Steve Konves</h1></header><section id="main"><article><h1 id="correlation-ids-in-practice">Correlation IDs in Practice</h1><p>Logging is hard.</p><p>Ensuring that you have useful data being logged at the correct severity level <em>before</em> systems start going down at 3am is hard enough. Logging too much data can often increase the size of the haystack without adding any proverbial needles. A Microservices architecture can exacerbate the issue by breaking up events between systems.</p><p>If your Orders service throws when getting inventory, it can be non-trivial to find the corresponding message logged by the Inventory service. And good luck discovering that the problem didn&#39;t even originate with the Inventory serivce, but was from a temporary outage of the Warehouse service.</p><p>In chapter 8 of his book <a href="https://www.amazon.com/Building-Microservices-Sam-Newman/dp/1491950358">Building Microservices</a>, Sam Newman describes the concept of the <strong>correlation ID</strong>, a value than can be used to identify all messages that originated from the same event. By passing these IDs between systems and including them in log messages, discovering the circumstances surrounding errors gets a lot more sane.</p><h2 id="how-we-do-it">How we do it</h2><p>In our implementations, the overall process for using correlation IDs looks like this:</p><ol><li>Get or create an ID at the start of the event</li><li>Store ID in the event context</li><li>Pass ID to all downstream events</li><li>If relevant, pass the ID back upstream when the event completes</li></ol><h3 id="get-an-id">Get an ID</h3><p>In a website or web service scenario, individual web requests are events. All log messages generated during a request share a correlation ID. In the case of a console app or Windows service, an event might start when a message is pulled down off of a message queue to be processed or when a database it queried. In the case of the dequeued message, all messages logged while processing that message would share a correlation ID. In the case of the database query, the same correlation ID could be used for <em>all</em> rows that are returned, or alternatively, one could be generated for <em>each</em> row.</p><p>The key thing to key in mind is to use the same ID for things that will be affected by the same failure.</p><p>For web services, we look for a <code>x-correlation-id</code> header on the request. If that header isn&#39;t present, we create a random GUID instead. Expressjs make this easy by allowing custom middleware. We built one that gets the request header or create a new <code>uuid</code> if it&#39;s missing and then also adds that ID as a header on the response object at the same time (see step 4).</p><p>It&#39;s pretty dead simple:</p><pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">middleware</span>(<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> correlationId = req.get(<span class="hljs-string">'X-Correlation-Id'</span>) || uuid.v4();
    res.set(<span class="hljs-string">'X-Correlation-Id'</span>, correlationId);
    next();
}</code></pre><p>Various message queue systems allow for adding custom properties onto a message. The system that enqueues the message tacks on a <code>CorrelationId</code> property. When the message is dequeued, if a correlation ID property is present it used, otherwise, a random GUID is used instead.</p><h3 id="store-an-id">Store an ID</h3></article><nav><div id="navtop"><h1 id="articles">Articles</h1></div><ul><li><a href="/pages/three-javascript-async-patterns.html">Three Javascript Async Patterns</a></li><li><a href="/pages/correlation-ids.html">Correlation IDs in Practice</a></li></ul><div id="navbottom"><h1 id="about-this-blog">About this blog</h1><p>Steve Konves is a software developer in the Phoenix area. This content is my own and doesn&#39;t necessarily reflect the views of my employer. If you find a typo or want to suggest a fix, feel free to submit a pull request.</p></div></nav></section><footer><p>Made with <a href="https://github.com/skonves/interblag">interblag</a> by Steve Konves</p></footer></body></html>